#!/usr/bin/env node
var path = require('path');
var fs = require('fs');
var docopt = require('docopt').docopt;
var builder = require('../lib/builder');
var package = require('../package');

var doc = fs.readFileSync(path.join(__dirname, 'docopt.txt'), 'utf8');
var result = docopt(doc, {version: package.version, help: true});
var deps = {};

var entries = result['<entry>'].map(function(s) {
  var split = s.split('::');
  var input = path.join(process.cwd(), split[0]);
  var output = split[1] ? path.join(process.cwd(), split[1]) : null;
  return [input, output];
});

var options = {
  prefix: result['--prefix'] || '/dev',
  rootDir: path.resolve(process.cwd(), (result['--rootDir'] || '.')),
  one: entries.length === 1,
  dev: result.build
};

entries.forEach(function(entry) {
  var inputFile = entry[0];
  var outputFile = entry[1];

  require(inputFile);
  if (!options.one && !outputFile) return;

  var result = builder.make(options);
  if (outputFile) {
    fs.writeFileSync(outputFile, result, 'utf8');
    console.log('bldr: ', path.relative(process.cwd(), outputFile));
  } else {
    console.log(output);
  }

  if (outputFile) {
    var depsList = [].concat(Object.keys(bldr.buildList));
    deps[path.relative(options.rootDir,outputFile)] = depsList;
  }
});

var outputDepsFile = result['--deps'];
if (outputDepsFile) {
  var output = '';
  for (key in deps) {
    output += key + ': ' + deps[key].join(' ') + '\n';
  }
  fs.writeFileSync(outputDepsFile, output, 'utf8');
};
